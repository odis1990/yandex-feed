name: Update Yandex Feed Automatically

on:
  # –ó–∞–ø—É—Å–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 UTC)
  schedule:
    - cron: '0 3 * * *'
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub
  workflow_dispatch:

jobs:
  update-feed:
    runs-on: ubuntu-latest
    
    # –ü—Ä–∞–≤–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    permissions:
      contents: write
      
    steps:
      # –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # –¢–æ–∫–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º

      # –®–∞–≥ 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ XML-—Ñ–∏–¥–∞
      - name: Generate Yandex Feed
        run: |
          # –ü—Ä–∏–º–µ—Ä –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ XML (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ –∫–æ–º–∞–Ω–¥—ã!)
          cat << 'EOF' > yandex-feed.xml
          <?xml version="1.0" encoding="UTF-8"?>
          <yml_catalog date="$(date +'%Y-%m-%d %H:%M')">
            <shop>
              <name>Example Shop</name>
              <offers>
                <offer id="1">
                  <name>Test Product</name>
                  <price>1000</price>
                </offer>
              </offers>
            </shop>
          </yml_catalog>
          EOF

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ XML –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          xmllint --noout yandex-feed.xml || exit 1

      # –®–∞–≥ 3: –ö–æ–º–º–∏—Ç –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
      - name: Commit and Push Changes
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions-bot@users.noreply.github.com"
          
          git add yandex-feed.xml
          
          # –ö–æ–º–º–∏—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --quiet --exit-code; then
            echo "No changes detected, skipping commit."
          else
            git commit -m "Auto-update Yandex feed [skip ci]"
            git push
          fi

      # –®–∞–≥ 4: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üö® **Feed update failed!** Check [Action logs](${github.server_url}/${github.repository}/actions/runs/${github.run_id})'
            })
